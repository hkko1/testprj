name: Update Images and Template
run-name: ${{ github.actor }} is doing to update connector and applier üöÄ
on:
  push:
    tags:
      - v[0-9]+.[0-9]+.[0-9]+
      - v[0-9]+.[0-9]+.[0-9]+-rc[0-9]+

jobs:
  job1:
    name: Setting up
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '18'

      - name: Run Junit Test
        run: mvn --batch-mode test

      - name: Archive Jacoco code coverage results
        uses: actions/upload-artifact@v3
        with:
          name: code-coverage-report-artifact
          path: |
            target/site/jacoco

      - run: |
          ls target/site/jacoco/*
          echo "============================"
          cat target/site/jacoco/jacoco.csv

      - run: echo "üçè Job1's status is ${{ job.status }}."

  job2-a:
    name: upload for develop
    needs: job1
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v3
        with:
          name: code-coverage-report-artifact
          path: target/site/jacoco

      - run: cat target/site/jacoco/jacoco.csv
      - name: Get total coverage percent
        run: |
          echo "[DEVELOP] total_coverage=$(python scripts/GetTotalPercentage.py 'target/site/jacoco/jacoco.csv')" >> "$GITHUB_ENV"
      - name: Comment
        run: echo "## [DEVELOP] Total code coverage report is ${{env.total_coverage}}"

      - run: echo "üçè Job2-a's status is ${{ job.status }}."

  job2-b:
    name: upload for production if rc is not present in tag
    needs: job1
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v3
        with:
          name: code-coverage-report-artifact
          path: target/site/jacoco

      - run: cat target/site/jacoco/jacoco.csv

      - name: Get total coverage percent
        if: ${{!contains(github.ref, '-rc')}}
        run: |
          echo "[PRODUCTION] total_coverage=$(python scripts/GetTotalPercentage.py 'target/site/jacoco/jacoco.csv')" >> "$GITHUB_ENV"

      - name: Comment
        if: ${{!contains(github.ref, '-rc')}}
        run: echo "## [PRODUCTION] Total code coverage report is ${{env.total_coverage}}"

      - run: echo "üçè Job2-a's status is ${{ job.status }}."
